<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LeftoverChef</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #111827; margin: 0; padding: 0; position: fixed; width: 100%; height: 100%; height: 100dvh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .app-container { width: 100%; height: 100%; background-color: #ffffff; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 480px) { .app-container { width: 375px; height: 812px; max-height: 95vh; border-radius: 40px; border: 8px solid #1f2937; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); } }
        .scroll-area { overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1; padding-bottom: 100px; }
        /* Safe Area Spacing f√ºr Notch */
        .safe-pt { padding-top: max(20px, env(safe-area-inset-top)); }
        .safe-pb { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4F46E5; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rating-star { cursor: pointer; transition: transform 0.1s; }
        .rating-star:active { transform: scale(1.3); }
    </style>
</head>
<body>
    <div class="app-container" id="app"></div>

    <script>
        // --- CONFIG ---
        const APP_KEY = "leftoverchef_master_v30";
        const DEFAULT_MODEL = "gemini-1.5-flash";

        function loadData() {
            try {
                let saved = localStorage.getItem(APP_KEY);
                if (!saved) saved = localStorage.getItem("leftoverchef_master_v29"); 
                if(saved) return JSON.parse(saved);
            } catch(e) { console.error(e); }
            return { 
                userXP: 0, recipesCooked: 0, moneySaved: 0, userRecipes: [], 
                apiKey: "", isPro: false, cart: [], aiModel: DEFAULT_MODEL 
            };
        }

        function saveData() {
            localStorage.setItem(APP_KEY, JSON.stringify({
                userXP: state.userXP,
                recipesCooked: state.recipesCooked,
                moneySaved: state.moneySaved,
                userRecipes: state.userRecipes,
                apiKey: state.apiKey,
                isPro: state.isPro,
                cart: state.cart,
                aiModel: state.aiModel
            }));
        }

        // --- MOCK DATA ---
        const mockIngredients = [{ id: 'tmt', name: "Tomaten (Demo)", icon: "fa-apple-alt" }, { id: 'egg', name: "Eier (Demo)", icon: "fa-egg" }];
        const mockRecipe = { title: "Omelett (Demo)", desc: "Platzhalter-Rezept (Demo Mode).", ingredients: [{amount: "3", unit: "Stk", name: "Eier"}], missing: "Schnittlauch", image: "https://images.unsplash.com/photo-1510693206972-df098062cb71?auto=format&fit=crop&w=800&q=80", myRating: 0 };

        // --- STATE ---
        const persistedData = loadData();
        let state = {
            screen: 'home', activeTab: 'home',
            scannedIngredients: [], selectedIngredients: [],
            userRecipes: persistedData.userRecipes || [], isPro: persistedData.isPro || false, apiKey: persistedData.apiKey || "",
            userXP: persistedData.userXP || 0, recipesCooked: persistedData.recipesCooked || 0, moneySaved: persistedData.moneySaved || 0,
            cart: persistedData.cart || [], aiModel: persistedData.aiModel || DEFAULT_MODEL,
            cookbookFilter: 'all', cookbookSort: 'newest', cookbookSearch: '', tempIngredients: [], prefilledData: null, cameraStream: null, aiStatus: "", selectedRecipeId: null
        };

        const CATEGORIES = [{ id: 'all', label: 'Alle' }, { id: 'breakfast', label: 'Fr√ºhst√ºck' }, { id: 'lunch', label: 'Mittag' }, { id: 'dinner', label: 'Abend' }, { id: 'snack', label: 'Snack' }, { id: 'drink', label: 'Drinks' }];
        const LEVELS = [{ name: "Tellerw√§scher", xp: 0 }, { name: "K√ºchenhilfe", xp: 100 }, { name: "Sous Chef", xp: 300 }, { name: "K√ºchenchef", xp: 600 }, { name: "Sternekoch", xp: 1000 }];
        
        const AI_MODELS = [
            { id: "gemini-1.5-flash", name: "Flash 1.5 (Standard)" },
            { id: "gemini-1.5-flash-latest", name: "Flash 1.5 (Latest)" },
            { id: "gemini-1.5-flash-001", name: "Flash 1.5 (v001)" },
            { id: "gemini-1.5-flash-002", name: "Flash 1.5 (v002)" },
            { id: "gemini-1.5-pro", name: "Pro 1.5 (Powerful)" }
        ];

        // --- GEMINI API ---
        async function fetchAvailableModels(apiKey) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                return data.models.filter(m => m.name.includes("gemini") && m.supportedGenerationMethods.includes("generateContent")).map(m => m.name.replace("models/", ""));
            } catch(e) { return []; }
        }

        async function callGeminiVision(base64Image) {
            if (!state.apiKey) return null;
            const key = state.apiKey.trim();
            const cleanBase64 = base64Image.split(',')[1];
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.aiModel}:generateContent?key=${key}`, {
                    method: "POST", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: "List ingredients in this image. Return ONLY valid JSON array: [{'id':'x','name':'German Name','icon':'fa-utensils'}]. Use double quotes." }, { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }] }],
                        generationConfig: { response_mime_type: "application/json" } 
                    })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) { 
                console.error("JSON Error", e);
                try { throw e; } catch(e2) { handleAiError(e); return null; }
            }
        }

        async function callGeminiRecipe(ingredientsList) {
            if (!state.apiKey) return null;
            const key = state.apiKey.trim();
            const ingString = ingredientsList.map(i => i.name).join(", ");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.aiModel}:generateContent?key=${key}`, {
                    method: "POST", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: `Create recipe from: ${ingString}. Return ONLY valid JSON: {"title":"Name","desc":"Instructions","time":"20 Min","missing":"Ingredient"}. Use double quotes.` }] }],
                        generationConfig: { response_mime_type: "application/json" }
                    })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) { handleAiError(e); return null; }
        }

        function handleAiError(e) {
            console.error("AI Error:", e);
            let msg = e.message;
            if (msg.includes("API key not valid")) msg = "Der API Key ist falsch.";
            if (msg.includes("JSON")) msg = "KI Antwort war kein g√ºltiges JSON.";
            if (msg.includes("not found")) msg = `Modell '${state.aiModel}' nicht gefunden. Bitte w√§hle ein anderes.`;
            alert(`‚ö†Ô∏è KI Fehler:\n${msg}`);
            transitionTo('settings');
        }

        // --- ACTIONS ---
        function init() { render(); }
        function transitionTo(screenName) { stopCamera(); state.screen = screenName; render(); }
        function switchTab(tab) { stopCamera(); state.activeTab = tab; state.screen = tab; render(); }

        async function startRealCamera(elemId) {
            const fallbackBtn = document.getElementById('camera-fallback-btn');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    state.cameraStream = stream;
                    const video = document.getElementById(elemId);
                    if(video) { 
                        video.srcObject = stream; 
                        video.play(); 
                        if(fallbackBtn) fallbackBtn.style.display = 'none';
                    }
                } catch (e) {
                    if(fallbackBtn) fallbackBtn.style.display = 'flex';
                }
            } else {
                if(fallbackBtn) fallbackBtn.style.display = 'flex';
            }
        }

        function stopCamera() { if (state.cameraStream) { state.cameraStream.getTracks().forEach(t => t.stop()); state.cameraStream = null; } }

        function captureAndScan() {
            const video = document.getElementById('camera-feed');
            state.screen = 'scanning'; 
            if(!state.apiKey || state.apiKey.length < 10) { alert("‚ö†Ô∏è Bitte erst API Key in den Einstellungen eintragen."); setTimeout(performMockScan, 500); render(); return; }
            render();
            if(video && video.srcObject && !video.paused) {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const base64 = canvas.toDataURL('image/jpeg', 0.5);
                    stopCamera(); performRealScan(base64);
                } catch(e) { stopCamera(); performMockScan(); }
            } else { stopCamera(); setTimeout(performMockScan, 1500); }
        }

        async function performRealScan(base64) {
            state.aiStatus = "Frage Gemini..."; render();
            const result = await callGeminiVision(base64);
            if(result && result.length > 0) { state.scannedIngredients = result; } 
            else { state.scannedIngredients = []; }
            state.selectedIngredients = [...state.scannedIngredients];
            transitionTo('verify');
        }

        function performMockScan() { state.scannedIngredients = mockIngredients; state.selectedIngredients = [...state.scannedIngredients]; transitionTo('verify'); }

        async function findRecipe() {
            if(state.selectedIngredients.length === 0) return alert("W√§hle Zutaten!");
            state.screen = 'scanning'; state.aiStatus = "Koche..."; render();
            let recipe = null;
            if (state.apiKey) recipe = await callGeminiRecipe(state.selectedIngredients);
            window.currentResultRecipe = recipe || mockRecipe;
            if(!window.currentResultRecipe.image) window.currentResultRecipe.image = "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=800&q=80";
            window.currentResultRecipe.myRating = 0; 
            transitionTo('results');
        }

        function saveAiRecipe() {
            if (!window.currentResultRecipe) return;
            const newRecipe = {
                id: Date.now(), title: window.currentResultRecipe.title, desc: window.currentResultRecipe.desc, time: window.currentResultRecipe.time || "20 Min",
                category: "dinner", isPublic: false, isUserCreated: true, ingredients: state.selectedIngredients.map(i => ({name: i.name, amount: "1", unit: "x"})), image: window.currentResultRecipe.image, myRating: 0
            };
            state.userRecipes.unshift(newRecipe); saveData(); state.cookbookFilter = 'all'; state.cookbookSort = 'newest'; state.cookbookSearch = ''; transitionTo('cookbook');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            if(!key.startsWith("AIza")) { alert("Der Key ist ung√ºltig. Er muss mit 'AIza' beginnen."); return; }
            state.apiKey = key; state.aiModel = model; saveData(); alert("Gespeichert!"); transitionTo('profile');
        }

        async function loadModels() {
            const key = document.getElementById('api-key-input').value.trim();
            if(!key) return alert("Key fehlt!");
            const btn = document.getElementById('load-models-btn'); btn.innerHTML = '‚è≥';
            const models = await fetchAvailableModels(key);
            btn.innerHTML = 'üîÑ';
            if(models.length > 0) {
                const select = document.getElementById('model-select'); select.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                const bestMatch = models.find(m => m.includes("flash")) || models[0]; select.value = bestMatch; alert(`‚úÖ Gefunden! W√§hle '${bestMatch}'.`);
            } else { alert("Konnte keine Modelle laden."); }
        }

        function rateRecipe(id, stars) {
            const recipe = state.userRecipes.find(r => r.id === id);
            if(recipe) { recipe.myRating = stars; saveData(); render(); }
        }

        // NEW: Delete Recipe
        function deleteRecipe(id) {
            if(confirm("M√∂chtest du dieses Rezept wirklich l√∂schen?")) {
                state.userRecipes = state.userRecipes.filter(r => r.id !== id);
                saveData();
                render();
            }
        }

        function addToCart(item) { if(!state.cart.includes(item)) { state.cart.push(item); saveData(); alert("Hinzugef√ºgt!"); } render(); }
        function removeFromCart(i) { state.cart.splice(i, 1); saveData(); render(); }
        function addManualScanIngredient() { const name = document.getElementById('manual-ing-input').value; if(name) { state.scannedIngredients.push({id:'man_'+Date.now(),name:name,icon:'fa-plus'}); state.selectedIngredients.push(state.scannedIngredients[state.scannedIngredients.length-1]); render(); } }
        function saveUserRecipe() {
            const title = document.getElementById('recipe-title').value; if(!title) return alert("Titel fehlt!");
            const newRecipe = { id: Date.now(), title: title, desc: document.getElementById('recipe-desc').value, category: document.getElementById('recipe-category').value, isPublic: document.getElementById('recipe-public').checked, ingredients: [...state.tempIngredients], image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=800&q=80", myRating: 0, communityRating: 0 };
            state.userRecipes.unshift(newRecipe); saveData(); transitionTo('cookbook');
        }
        function addTempIngredient() { const name = document.getElementById('ing-name').value; if(name) { state.tempIngredients.push({ amount: document.getElementById('ing-amount').value, unit: document.getElementById('ing-unit').value, name: name }); render(); setTimeout(()=>document.getElementById('ing-name').focus(), 50); } }
        function removeTempIngredient(i) { state.tempIngredients.splice(i, 1); render(); }
        function cookRecipe() { state.userXP += 50; state.recipesCooked++; state.moneySaved += 3.50; saveData(); confetti({particleCount:100, spread:70, origin:{y:0.6}}); alert("+50 XP"); transitionTo('profile'); }
        function toggleIngredient(id) { const idx = state.selectedIngredients.findIndex(i => i.id === id); if(idx > -1) state.selectedIngredients.splice(idx, 1); else { const item = state.scannedIngredients.find(i => i.id === id); if(item) state.selectedIngredients.push(item); } render(); }
        function getCurrentLevel() { return LEVELS.slice().reverse().find(l => state.userXP >= l.xp) || LEVELS[0]; }
        function getNextLevel() { return LEVELS.find(l => l.xp > state.userXP) || LEVELS[LEVELS.length - 1]; }

        // --- RENDER ---
        function render() {
            const app = document.getElementById('app');
            let content = '';
            switch(state.screen) {
                case 'home': content = ScreenHome(); break;
                case 'camera': content = ScreenCamera(); break;
                case 'scanning': content = ScreenScanning(); break;
                case 'verify': content = ScreenVerify(); break;
                case 'results': content = ScreenResults(); break;
                case 'cookbook': content = ScreenCookbook(); break;
                case 'shopping-list': content = ScreenShoppingList(); break;
                case 'profile': content = ScreenProfile(); break;
                case 'settings': content = ScreenSettings(); break;
                case 'add-recipe': content = ScreenAddRecipe(); break;
                case 'recipe-detail': content = ScreenRecipeDetail(); break;
                case 'import-choice': content = ScreenImportChoice(); break;
                case 'ocr-scan': content = ScreenOCRScan(); break;
                case 'import-link': content = ScreenImportLink(); break;
                default: content = ScreenHome();
            }
            const hasNav = ['home', 'cookbook', 'shopping-list', 'profile'].includes(state.screen);
            app.innerHTML = `<div class="flex-1 overflow-hidden relative bg-gray-50 flex flex-col w-full">${content}</div>${hasNav ? BottomNav() : ''}`;
            if(state.screen === 'camera') startRealCamera('camera-feed');
        }

        // Components
        const BottomNav = () => `<div class="bg-white border-t border-gray-200 px-4 py-3 flex justify-between items-center z-50 w-full shrink-0 safe-pb"><button onclick="switchTab('home')" class="flex flex-col items-center gap-1 w-12 ${state.activeTab==='home'?'text-blue-600':'text-gray-400'}"><i class="fas fa-magic text-xl"></i><span class="text-[10px] font-bold">Scan</span></button><button onclick="switchTab('cookbook')" class="flex flex-col items-center gap-1 w-12 ${state.activeTab==='cookbook'?'text-blue-600':'text-gray-400'}"><i class="fas fa-book-open text-xl"></i><span class="text-[10px] font-bold">Buch</span></button><button onclick="switchTab('shopping-list')" class="flex flex-col items-center gap-1 w-12 ${state.activeTab==='shopping-list'?'text-blue-600':'text-gray-400'}"><i class="fas fa-shopping-basket text-xl"></i><span class="text-[10px] font-bold">Liste</span></button><button onclick="switchTab('profile')" class="flex flex-col items-center gap-1 w-12 ${state.activeTab==='profile'?'text-blue-600':'text-gray-400'}"><i class="fas fa-user text-xl"></i><span class="text-[10px] font-bold">Profil</span></button></div>`;

        const ScreenHome = () => `
            <div class="flex flex-col h-full w-full"><div class="flex-1 overflow-y-auto p-6 pt-14 scroll-area"><div class="flex justify-between items-center mb-8"><div><h1 class="text-2xl font-bold text-gray-800">LeftoverChef</h1><p class="text-sm text-gray-500">Gemini Kitchen Assistant</p></div><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-user"></i></div></div><div onclick="transitionTo('camera')" class="bg-gradient-to-br from-gray-900 to-blue-900 text-white rounded-3xl p-8 shadow-xl cursor-pointer active:scale-95 transition-transform mb-6 relative overflow-hidden"><div class="absolute -right-6 -top-6 bg-blue-500 w-32 h-32 rounded-full blur-3xl opacity-30"></div><i class="fas fa-camera text-4xl mb-4 text-blue-400"></i><h2 class="text-2xl font-bold mb-1">Scan Starten</h2><p class="text-gray-400 text-sm">${state.apiKey ? 'Gemini Aktiv' : 'Demo Modus'}</p></div><div class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm"><h3 class="font-bold text-gray-800 mb-2">Status</h3><p class="text-sm text-gray-500">Level: ${getCurrentLevel().name} (${state.userXP} XP)</p></div></div></div>`;

        // FIX: BACK BUTTON VISIBLE & CLICKABLE
        const ScreenCamera = () => `
            <div class="h-full bg-black relative flex flex-col w-full">
                <div class="absolute top-0 w-full p-6 safe-pt flex justify-between z-[100]">
                    <button onclick="transitionTo('home')" class="w-12 h-12 bg-black/60 rounded-full backdrop-blur flex items-center justify-center border border-white/30 text-white shadow-lg active:scale-90 transition-transform">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="flex-1 relative flex items-center justify-center overflow-hidden">
                    <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover"></video>
                    <div class="absolute inset-0 border-[2px] border-white/30 m-8 rounded-3xl pointer-events-none"></div>
                    <div id="camera-fallback-btn" style="display:none" class="absolute inset-0 flex items-center justify-center bg-black z-30 flex-col"><p class="text-white mb-4">Kein Kamera-Zugriff</p><button onclick="captureAndScan()" class="bg-white text-black px-6 py-3 rounded-xl font-bold">Demo-Scan benutzen</button></div>
                </div>
                <div class="h-32 bg-black flex items-center justify-center shrink-0 safe-pb"><button onclick="captureAndScan()" class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-90 transition-transform"><div class="w-16 h-16 bg-white rounded-full"></div></button></div>
            </div>`;

        const ScreenScanning = () => `
            <div class="h-full bg-gray-900 flex items-center justify-center flex-col text-white w-full">
                <div class="loader mb-6"></div>
                <p class="mb-6">${state.aiStatus || "Analysiere..."}</p>
                <button onclick="transitionTo('home')" class="text-gray-400 text-sm border border-gray-700 px-4 py-2 rounded-lg">Abbrechen</button>
            </div>`;

        const ScreenVerify = () => `<div class="flex flex-col h-full bg-white w-full slide-up"><div class="p-6 pt-14 border-b bg-white z-10"><h2 class="text-xl font-bold">Zutaten best√§tigen</h2></div><div class="flex-1 overflow-y-auto p-4 scroll-area"><div class="flex gap-2 mb-4 p-3 bg-gray-50 rounded-xl border border-gray-100"><input type="text" id="manual-ing-input" class="flex-1 bg-white border border-gray-200 rounded-lg px-3 text-sm outline-none focus:border-blue-500" placeholder="Zutat vergessen?"><button onclick="addManualScanIngredient()" class="bg-blue-600 text-white w-10 rounded-lg flex items-center justify-center"><i class="fas fa-plus"></i></button></div>${state.scannedIngredients.length === 0 ? '<p class="text-center text-gray-400 text-sm my-4">Nichts erkannt? F√ºge es manuell hinzu.</p>' : ''}${state.scannedIngredients.map(i => `<div onclick="toggleIngredient('${i.id}')" class="flex items-center p-3 mb-2 rounded-xl border-2 cursor-pointer ${state.selectedIngredients.find(x=>x.id===i.id)?'border-blue-500 bg-blue-50':'border-gray-100'}"><i class="fas ${i.icon || 'fa-carrot'} text-gray-500 w-8 text-center"></i><span class="font-bold text-gray-700 ml-2">${i.name}</span>${state.selectedIngredients.find(x=>x.id===i.id)?'<i class="fas fa-check ml-auto text-blue-500"></i>':''}</div>`).join('')}</div><div class="p-4 border-t shrink-0 safe-pb"><button onclick="findRecipe()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold shadow-lg">Rezept erstellen</button></div></div>`;

        const ScreenResults = () => { 
            const r = window.currentResultRecipe; 
            return `
            <div class="flex flex-col h-full bg-white w-full slide-up">
                <div class="h-64 relative bg-gray-200 shrink-0">
                    <img src="${r.image}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 p-6 text-white">
                        <div class="bg-blue-600 text-[10px] font-bold px-2 py-1 rounded inline-block mb-2">GEMINI REZEPT</div>
                        <h2 class="text-2xl font-bold leading-tight">${r.title}</h2>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 scroll-area">
                    <p class="text-gray-600 text-sm mb-6 leading-relaxed">${r.desc}</p>
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 flex items-center text-sm mb-6">
                        <i class="fas fa-shopping-basket text-orange-500 mr-3"></i>
                        <span>Fehlt oft: <b>${r.missing || "Gew√ºrze"}</b></span>
                    </div>
                    <button onclick="addToCart('${r.missing || 'Gew√ºrze'}')" class="w-full bg-black text-white py-3 rounded-xl font-bold mb-4">+ Fehlende Zutat auf Liste</button>
                    
                    <div class="flex gap-2 mt-auto pb-4">
                        <button onclick="saveAiRecipe()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Speichern</button>
                        <button onclick="transitionTo('home')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Verwerfen</button>
                    </div>
                </div>
            </div>`; 
        };

        // FIX: DELETE BUTTON ADDED
        const ScreenCookbook = () => `
            <div class="flex flex-col h-full bg-white w-full relative">
                <div class="p-6 pt-14 border-b bg-white z-10 sticky top-0">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Kochbuch</h2><button onclick="transitionTo('add-recipe')" class="bg-black text-white w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-plus"></i></button></div><input type="text" placeholder="Suche..." class="w-full bg-gray-100 rounded-xl p-3 text-sm outline-none" oninput="state.cookbookSearch=this.value; render()">
                </div>
                <div class="flex-1 overflow-y-auto p-6 pb-20 scroll-area">
                    ${state.userRecipes.length===0?'<p class="text-gray-400 text-center mt-10">Noch keine Rezepte.</p>':''}
                    ${state.userRecipes.filter(r=>r.title.toLowerCase().includes(state.cookbookSearch.toLowerCase())).map(r=>`
                        <div class="relative group">
                            <div onclick="state.selectedRecipeId=${r.id}; transitionTo('recipe-detail')" class="bg-white border border-gray-200 rounded-2xl p-3 flex gap-4 shadow-sm mb-4 cursor-pointer active:bg-gray-50">
                                <div class="w-20 h-20 bg-gray-100 rounded-xl overflow-hidden shrink-0"><img src="${r.image}" class="w-full h-full object-cover"></div>
                                <div class="flex-1 flex flex-col justify-center pr-8">
                                    <h3 class="font-bold text-gray-800 mb-1">${r.title}</h3>
                                    <div class="text-xs text-gray-500">${r.ingredients.length} Zutaten</div>
                                    <div class="flex mt-2 text-amber-400 text-xs">${[1,2,3,4,5].map(s => `<i class="${r.myRating >= s ? 'fas' : 'far'} fa-star"></i>`).join('')}</div>
                                </div>
                            </div>
                            <!-- DELETE BUTTON -->
                            <button onclick="deleteRecipe(${r.id})" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full shadow-md flex items-center justify-center text-gray-400 hover:text-red-500 z-10">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>`;

        const ScreenShoppingList = () => `<div class="flex flex-col h-full bg-white w-full"><div class="p-6 pt-14 border-b flex justify-between items-center shrink-0"><h2 class="text-2xl font-bold">Einkaufsliste</h2><span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold">${state.cart.length}</span></div><div class="flex-1 overflow-y-auto p-6 scroll-area">${state.cart.length === 0 ? `<div class="flex flex-col items-center justify-center h-full opacity-40"><i class="fas fa-shopping-cart text-6xl mb-4"></i><p>Alles erledigt!</p></div>` : state.cart.map((item, i) => `<div class="flex items-center justify-between bg-gray-50 p-4 mb-3 rounded-xl border border-gray-100 shadow-sm"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full border-2 border-gray-300"></div><span class="font-bold text-gray-700">${item}</span></div><button onclick="removeFromCart(${i})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`).join('')}</div></div>`;

        const ScreenRecipeDetail = () => { 
            const r = state.userRecipes.find(x => x.id === state.selectedRecipeId); 
            if(!r) {setTimeout(()=>transitionTo('cookbook'),0); return '';} 
            return `
            <div class="flex flex-col h-full bg-white w-full slide-up z-50">
                <div class="relative h-64 shrink-0">
                    <img src="${r.image}" class="w-full h-full object-cover">
                    <button onclick="transitionTo('cookbook')" class="absolute top-6 left-6 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white"><i class="fas fa-arrow-left"></i></button>
                    <div class="absolute bottom-0 left-0 p-6 text-white"><h2 class="text-2xl font-bold">${r.title}</h2></div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 scroll-area">
                    <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Bewertung</h4>
                        <div class="flex gap-2 text-2xl text-gray-300">
                            ${[1,2,3,4,5].map(s => `<i onclick="rateRecipe(${r.id}, ${s})" class="fas fa-star rating-star ${r.myRating >= s ? 'text-amber-400' : ''}"></i>`).join('')}
                        </div>
                    </div>
                    <h3 class="font-bold mb-2">Zutaten</h3>
                    <div class="space-y-2 mb-6">${r.ingredients.map(i => `<div class="flex justify-between border-b pb-2 text-sm"><span>${i.name}</span><b>${i.amount} ${i.unit}</b></div>`).join('')}</div>
                    <h3 class="font-bold mb-2">Zubereitung</h3>
                    <p class="text-sm text-gray-600">${r.desc}</p>
                </div>
                <div class="p-4 border-t shrink-0 safe-pb"><button onclick="cookRecipe()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg">Gekocht!</button></div>
            </div>`; 
        };

        const ScreenProfile = () => `
            <div class="flex flex-col h-full bg-white w-full">
                <div class="p-6 pt-14 border-b flex justify-between items-center shrink-0"><h2 class="text-2xl font-bold">Profil</h2><button onclick="transitionTo('settings')" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md active:scale-95 transition-transform"><i class="fas fa-cog mr-1"></i> Einstellungen</button></div>
                <div class="flex-1 overflow-y-auto p-6 scroll-area">
                    <div class="bg-gray-900 text-white rounded-2xl p-6 mb-6 shadow-xl"><h3 class="text-lg font-bold">Marco Hentze</h3><p class="text-blue-400 text-sm font-bold mb-4">${getCurrentLevel().name}</p><div class="w-full bg-gray-700 h-2 rounded-full mb-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${(state.userXP/getNextLevel().xp)*100}%"></div></div><div class="flex justify-between text-xs text-gray-400"><span>${state.userXP} XP</span><span>Ziel: ${getNextLevel().xp}</span></div></div>
                    ${!state.apiKey ? `<div class="bg-amber-50 border border-amber-200 p-4 rounded-xl text-sm text-amber-800 mb-6 cursor-pointer" onclick="transitionTo('settings')">‚ö†Ô∏è <b>Kein API Key.</b> Klicke hier.</div>` : ''}
                    <div class="grid grid-cols-2 gap-4"><div class="bg-gray-50 p-4 rounded-xl border text-center"><div class="text-2xl font-bold">${state.recipesCooked}</div><div class="text-xs text-gray-500">Gekocht</div></div><div class="bg-gray-50 p-4 rounded-xl border text-center"><div class="text-2xl font-bold text-green-600">${state.moneySaved.toFixed(2)}‚Ç¨</div><div class="text-xs text-gray-500">Gespart</div></div></div>
                </div>
            </div>`;

        const ScreenSettings = () => `
            <div class="flex flex-col h-full bg-white w-full slide-up z-50">
                <div class="p-6 pt-14 border-b flex items-center"><button onclick="transitionTo('profile')" class="mr-4 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-lg">Einstellungen</h2></div>
                <div class="flex-1 overflow-y-auto p-6 scroll-area">
                    <h3 class="font-bold mb-2">Google Gemini API Key</h3>
                    <input type="password" id="api-key-input" oninput="validateKeyInput(this)" value="${state.apiKey}" class="w-full bg-gray-100 p-4 rounded-xl text-sm border border-gray-300 outline-none" placeholder="AIza...">
                    <div id="key-status" class="text-xs mt-1 mb-6"></div>
                    
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">KI Modell</label>
                    <div class="flex gap-2 mb-8">
                        <select id="model-select" class="flex-1 bg-gray-100 p-4 rounded-xl text-sm border border-gray-300 outline-none">
                            ${AI_MODELS.map(m => `<option value="${m.id}" ${state.aiModel === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                        <button onclick="loadModels()" id="load-models-btn" class="bg-blue-50 text-blue-600 border border-blue-200 px-3 rounded-xl font-bold text-xl">üîÑ</button>
                    </div>

                    <button onclick="saveSettings()" id="save-btn" class="w-full bg-black text-white py-4 rounded-xl font-bold">Speichern</button>
                    <div class="text-center p-4 mt-8"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 font-bold text-sm underline">Key kostenlos holen ‚Üó</a></div>
                </div>
            </div>`;

        const ScreenAddRecipe = () => `<div class="flex flex-col h-full bg-white w-full slide-up"><div class="p-4 pt-14 border-b flex justify-between items-center"><button onclick="transitionTo('cookbook')"><i class="fas fa-times"></i></button><h3 class="font-bold">Neues Rezept</h3><div class="w-4"></div></div><div class="flex-1 overflow-y-auto p-6 scroll-area"><input type="text" id="recipe-title" class="w-full text-xl font-bold mb-4 border-b pb-2 outline-none" placeholder="Titel"><select id="recipe-category" class="w-full mb-6 bg-gray-50 p-3 rounded-xl">${CATEGORIES.map(c => `<option value="${c.id}">${c.label}</option>`).join('')}</select><div class="flex gap-2 mb-4"><input type="number" id="ing-amount" class="w-20 bg-gray-50 p-3 rounded-xl" placeholder="1"><select id="ing-unit" class="w-24 bg-gray-50 p-3 rounded-xl">${['Stk','g','ml'].map(u => `<option>${u}</option>`).join('')}</select><input type="text" id="ing-name" class="flex-1 bg-gray-50 p-3 rounded-xl" placeholder="Zutat"><button onclick="addTempIngredient()" class="bg-green-600 text-white p-3 rounded-xl"><i class="fas fa-plus"></i></button></div><div class="mb-6 space-y-2">${state.tempIngredients.map((ing, i) => `<div class="flex justify-between bg-gray-50 p-2 rounded-lg text-sm"><span>${ing.amount} ${ing.unit} ${ing.name}</span><i onclick="removeTempIngredient(${i})" class="fas fa-times text-red-400"></i></div>`).join('')}</div><textarea id="recipe-desc" class="w-full bg-gray-50 p-3 rounded-xl h-32" placeholder="Anleitung..."></textarea><div class="mt-4 flex items-center gap-3"><input type="checkbox" id="recipe-public" class="w-5 h-5"><label>√ñffentlich</label></div></div><div class="p-4 border-t shrink-0 safe-pb"><button onclick="saveUserRecipe()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Speichern</button></div></div>`;
        const ScreenImportChoice = () => `<div class="flex flex-col h-full bg-white slide-up z-50"><div class="p-6 pt-14 flex justify-between items-center"><button onclick="transitionTo('cookbook')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-times"></i></button><h3 class="font-bold">Rezept importieren</h3><div class="w-8"></div></div><div class="flex-1 p-6 flex flex-col justify-center gap-4"><button onclick="transitionTo('add-recipe')" class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-xl"><i class="fas fa-pen"></i></div><div class="text-left"><h4 class="font-bold text-gray-800">Manuell</h4></div></button><button onclick="transitionTo('ocr-scan')" class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-xl"><i class="fas fa-camera"></i></div><div class="text-left"><h4 class="font-bold text-gray-800">Buch scannen</h4></div></button><button onclick="transitionTo('import-link')" class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-xl"><i class="fas fa-link"></i></div><div class="text-left"><h4 class="font-bold text-gray-800">Web Link</h4></div></button></div></div>`;
        const ScreenOCRScan = () => { setTimeout(() => { state.prefilledData = { title: "Apfelkuchen (Scan)", desc: "Gefunden in: Omas Backbuch", category: "snack", ingredients: [{amount:"3",unit:"Stk",name:"√Ñpfel"}, {amount:"200",unit:"g",name:"Mehl"}] }; transitionTo('add-recipe'); }, 2500); return `<div class="h-full bg-black flex items-center justify-center text-white flex-col"><div class="loader mb-6"></div><p>Text wird erkannt...</p></div>`; };
        const ScreenImportLink = () => `<div class="flex flex-col h-full bg-white slide-up z-50"><div class="p-6 pt-14 flex justify-between items-center border-b border-gray-100"><button onclick="transitionTo('import-choice')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><i class="fas fa-arrow-left"></i></button><h3 class="font-bold">Link Import</h3><div class="w-8"></div></div><div class="p-6 flex-1"><input type="text" id="import-url" placeholder="https://..." class="flex-1 bg-gray-50 border border-gray-200 rounded-xl p-4 font-medium w-full mb-4"><button onclick="setTimeout(()=>{ state.prefilledData={title:'Web Rezept', desc:'Importiert von Chefkoch', category:'dinner', ingredients:[{amount:'500',unit:'g',name:'Nudeln'}]}; transitionTo('add-recipe'); }, 1500)" class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg">Laden</button></div></div>`;

        init();
    </script>
</body>
</html>
